spec_id: SPEC-REFACTOR-DEDUP-001
title: "Deduplicate sequential/parallel translation execution paths"
status: draft

given_when_then:
  - given: "streaming_translator.py has _translate_sequential() and _translate_parallel() with 70% code overlap"
    when: "developer extracts common logic into shared helper methods"
    then: "both methods use unified _write_translations() and _update_task_progress() functions"

  - given: "file writing logic repeated in lines 395-396 and 475-476"
    when: "developer creates _write_translations(results: dict, output_file: str) method"
    then: "both sequential and parallel paths call the same method"

  - given: "progress update logic scattered across lines 380-390 and 445-463"
    when: "developer creates _update_task_progress(success: bool, chunk_index: int, progress: Progress, task_id: TaskID)"
    then: "single consolidated pattern replaces both implementations"

acceptance_tests:
  - id: TEST-REFACTOR-DEDUP-001-AC1
    desc: "_write_translations() writes content with correct formatting (double newline between chunks)"
    expected: "File contains exactly N+1 newlines for N chunks, indentation preserved"

  - id: TEST-REFACTOR-DEDUP-001-AC2
    desc: "_write_translations() creates output file with UTF-8 encoding"
    expected: "Output file readable with UTF-8 decoder, no encoding errors"

  - id: TEST-REFACTOR-DEDUP-001-AC3
    desc: "_update_task_progress() marks success correctly in sequential mode"
    expected: "Progress bar shows 100% for successful chunk, hidden on completion"

  - id: TEST-REFACTOR-DEDUP-001-AC4
    desc: "_update_task_progress() marks failure correctly in parallel mode"
    expected: "Progress bar shows failure message in red, remains visible"

  - id: TEST-REFACTOR-DEDUP-001-AC5
    desc: "Both _translate_sequential() and _translate_parallel() produce identical file output"
    expected: "Content files identical byte-for-byte when given same input"

  - id: TEST-REFACTOR-DEDUP-001-AC6
    desc: "Refactored code maintains 100% test coverage"
    expected: "pytest coverage report shows 100% line/branch coverage"

dependencies:
  - governance: "memory.md (recent changes section)"
  - patterns: "SDDÃ—TDD development loop from system prompt"

linked_tasks:
  - TASK-20251228-REFACTOR-DEDUP-001

notes:
  - "Lines 395-396 and 475-476 are duplicate: file writing with content joining"
  - "Lines 380-390 and 445-463 are duplicate: progress bar update patterns"
  - "Estimated 100+ lines of duplication to consolidate"
